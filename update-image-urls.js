const fs = require('fs');
const path = require('path');

// Supabase Storage URLs
const SUPABASE_BASE_URL = 'https://srpspzgemnfxkqalgjmz.supabase.co/storage/v1/object/public/wolf-property-images';

const IMAGE_URL_MAPPING = {
    'images/wolf-logo.png': `${SUPABASE_BASE_URL}/wolf-logo.png`,
    'images/people/adam_starr.png': `${SUPABASE_BASE_URL}/people/adam_starr.png`,
    'images/people/patricia_holmes.jpg': `${SUPABASE_BASE_URL}/people/patricia_holmes.jpg`
};

function updateFile(filePath, replacements) {
    try {
        let content = fs.readFileSync(filePath, 'utf8');
        let updated = false;

        Object.entries(replacements).forEach(([oldPath, newUrl]) => {
            const regex = new RegExp(oldPath.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            if (content.includes(oldPath)) {
                content = content.replace(regex, newUrl);
                updated = true;
                console.log(`  ✓ Updated ${oldPath} -> ${newUrl}`);
            }
        });

        if (updated) {
            fs.writeFileSync(filePath, content, 'utf8');
            console.log(`✅ Updated ${filePath}`);
        } else {
            console.log(`⏭️  No changes needed in ${filePath}`);
        }

        return updated;
    } catch (error) {
        console.error(`❌ Error updating ${filePath}:`, error.message);
        return false;
    }
}

function updateImageUrls() {
    console.log('🔄 Updating image URLs to use Supabase Storage...\n');

    const filesToUpdate = [
        'index.html',
        'about.html',
        'setup-database.sql',
        'complete-database-setup.sql'
    ];

    let totalUpdated = 0;

    filesToUpdate.forEach(fileName => {
        console.log(`📝 Processing ${fileName}...`);
        if (fs.existsSync(fileName)) {
            const wasUpdated = updateFile(fileName, IMAGE_URL_MAPPING);
            if (wasUpdated) totalUpdated++;
        } else {
            console.log(`⚠️  File ${fileName} not found, skipping...`);
        }
        console.log('');
    });

    console.log('📊 Summary:');
    console.log(`✅ ${totalUpdated} files updated`);
    console.log(`🖼️  ${Object.keys(IMAGE_URL_MAPPING).length} image paths replaced`);
    
    console.log('\n🌐 New Image URLs:');
    Object.entries(IMAGE_URL_MAPPING).forEach(([local, url]) => {
        console.log(`  ${local} -> ${url}`);
    });

    console.log('\n✨ Update complete! Your website now uses Supabase Storage for images.');
}

// Create a helper file for easy URL access in JavaScript
function createImageUrlsHelper() {
    const jsContent = `// Supabase Storage Image URLs
// Auto-generated by update-image-urls.js

const IMAGE_URLS = {
    wolfLogo: '${IMAGE_URL_MAPPING['images/wolf-logo.png']}',
    adamStarr: '${IMAGE_URL_MAPPING['images/people/adam_starr.png']}',
    patriciaHolmes: '${IMAGE_URL_MAPPING['images/people/patricia_holmes.jpg']}'
};

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = IMAGE_URLS;
}

// Make available globally in browser
if (typeof window !== 'undefined') {
    window.IMAGE_URLS = IMAGE_URLS;
}
`;

    fs.writeFileSync('image-urls.js', jsContent, 'utf8');
    console.log('📄 Created image-urls.js helper file');
}

// Run the update
updateImageUrls();
createImageUrlsHelper(); 